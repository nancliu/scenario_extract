# 日期特征分类说明文档

## 修改概述

已更新《算法设计文档-02-历史基准建立算法.md》，增强了日期事件特征分类逻辑，正确处理调休情况和节假日分类。

## 新增的日期特征分类体系

### 1. 工作日类型 (workday)
- **正常工作日**: 周一至周五且不在节假日表中
- **调休工作日**: 本来是周末但因节假日调休安排需要上班
  - 条件: `h.is_workday = true`
  - 示例: 2025-01-26(周日)、2025-02-15(周六)等
  - 特点: 流量模式可能介于正常工作日和周末之间

### 2. 周末类型 (weekend)  
- **正常周末**: 周六、周日且不在节假日表中
- **调休取消周末**: 原本周末但因调休被取消（此类数据归入workday）

### 3. 免费通行节假日 (holiday_free)
- 条件: `h.is_free = true AND h.is_workday = false`
- 包括: 春节、劳动节、国庆节  
- 特征: 交通流量显著激增，流量模式与平时差异极大
- 基准计算: 单独建立基准模式，权重较高

### 4. 收费节假日 (holiday_nofree)
- 条件: `h.is_free = false AND h.is_workday = false`  
- 包括: 元旦、清明节、端午节、中秋节
- 特征: 流量有所增加但相对温和，主要体现返乡探亲需求
- 基准计算: 单独建立基准模式，相对于免费节假日权重较低

## 核心SQL逻辑

```sql
-- Pattern_type生成逻辑
CASE 
    WHEN h.is_free = true AND h.is_workday = false THEN 'holiday_free'
    WHEN h.is_free = false AND h.is_workday = false THEN 'holiday_nofree'  
    WHEN h.is_workday = true THEN 'workday'  -- 包含调休工作日
    WHEN h.holiday_date IS NULL AND EXTRACT(DOW FROM timestamp) IN (0,6) THEN 'weekend'
    ELSE 'workday'  -- 默认归类为工作日
END as pattern_type
```

## 调休处理的关键点

1. **调休工作日识别**: 通过 `h.is_workday = true` 和自然星期几的组合判断
2. **数据归类**: 调休工作日的流量数据归入 `workday` 类别
3. **基准计算**: 调休日和正常工作日共同建立工作日基准模式
4. **特殊标记**: 提供 `is_adjusted_workday` 字段用于区分调休工作日

## 节假日表依赖

必须依赖 `dim.dim_holidays` 表的以下字段:
- `holiday_date`: 节假日日期
- `holiday_name`: 节假日名称  
- `is_free`: 是否免费通行
- `is_workday`: 是否为工作日（用于标识调休）

## 输出格式变更

### 基础流量基准
新增了4种pattern_type的基准模式:
- `workday`: 工作日（含调休）
- `weekend`: 周末
- `holiday_free`: 免费节假日
- `holiday_nofree`: 收费节假日

### OD基准流量  
同样支持4种pattern_type的分类基准计算

## 算法影响

1. **基准精度提升**: 通过细化分类，提高不同时期流量基准的准确性
2. **节假日处理**: 免费通行期间的流量激增得到专门处理
3. **调休识别**: 正确处理调休工作日，避免分类错误
4. **业务适配**: 更好地适应中国的节假日和调休制度

## 注意事项

1. 确保 `dim.dim_holidays` 表数据的完整性和准确性
2. 调休日期的准确标记对分类结果至关重要  
3. 新分类体系需要足够的历史数据支持基准计算
4. 建议定期验证节假日分类的正确性 