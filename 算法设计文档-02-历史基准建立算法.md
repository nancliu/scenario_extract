# 历史基准建立算法设计

**算法编号**: ALG-002
**算法名称**: 历史基准建立算法
**算法功能**: 基于历史流量数据和OD数据建立时段基准流量模式，为流量增长率计算和事件判别提供基准参考
**设计版本**: v1.2
**设计日期**: 2025-06-17
**更新日期**: 2025-06-19

---

## 1. 算法目标

### 主要功能

- 建立分时段的历史流量基准模式
- 建立分时段的OD流量基准模式
- 支持工作日/周末差异化基准计算
- 提供流量增长率计算的基准参考
- 为动态阈值调整提供统计基础
- 支持OD关系异常检测基准参考

### 应用场景

- 收费站入口流量基准建立
- 断面门架流量基准建立
- OD对流量基准建立
- 实时流量与历史同期对比
- 流量异常检测基准参考
- OD流量异常检测和路径分析

### 预期效果

- 基准计算准确率 ≥ 85%
- 数据处理延迟 < 10秒
- 支持30天历史窗口滚动更新
- 基准可信度评估机制
- OD基准覆盖率 ≥ 80%
- OD数据窗口：约60天完整历史数据
- OD基准更新周期：每日一次（无需滚动更新）

---

## 2. 理论基础

### 相关交通工程理论

- **交通流时变特性理论**: 交通流量具有明显的时段规律性和周期性特征
- **交通需求模式理论**: 工作日与周末、节假日的交通需求模式存在显著差异
- **OD流量分布理论**: 起讫点(Origin-Destination)流量体现空间交通需求分布规律
- **路径选择理论**: 交通流在路网中的分布遵循用户均衡和系统最优原理
- **统计学基础**: 基于历史数据的统计分析和趋势预测方法

### 数学模型

#### 基础流量基准计算模型
基准流量计算采用加权平均模型：

```
BaseFlow(t,d) = Σ(Wi × Flow(t,d,i)) / Σ(Wi)

其中：
- BaseFlow(t,d): 时段t、星期d的基准流量
- Flow(t,d,i): 第i天同时段同星期的历史流量
- Wi: 第i天的权重系数（距离当前时间越近权重越大）
- t: 时段标识（以小时为单位，0-23）
- d: 星期标识（1-7，1为周一）
```

#### OD流量基准计算模型
OD流量基准计算采用分层加权平均模型：

```
BaseODFlow(o,d,t,w) = Σ(Wi × ODFlow(o,d,t,w,i)) / Σ(Wi)

其中：
- BaseODFlow(o,d,t,w): 起点o到终点d在时段t、星期w的基准OD流量
- ODFlow(o,d,t,w,i): 第i天同OD对同时段同星期的历史流量
- Wi: 第i天的权重系数（时间衰减 + OD相似性权重）
- o: 起点收费站编码
- d: 终点收费站编码
- t: 时段标识（以小时为单位，0-23）
- w: 星期标识（1-7，1为周一）

权重计算公式：
Wi = TimeWeight(i) × SimilarityWeight(o,d)
TimeWeight(i) = WEIGHT_DECAY_FACTOR^(current_day - i)
SimilarityWeight(o,d) = exp(-distance(o,d)/DISTANCE_DECAY)
```

### 参考标准

- 《公路工程技术标准》(JTG B01-2014)
- 《城市道路交通规划设计规范》(GB 50220-95)
- 交通流量统计分析方法相关标准

---

## 3. 算法逻辑

### 输入数据格式

#### 基础流量数据格式

```json
{
  "stationId": "string",           // 站点ID（收费站或门架）
  "timestamp": "YYYY-MM-DD HH:MM:SS", // 数据时间戳
  "flowValue": "number",           // 流量值（veh/5min）
  "dataQuality": "number",         // 数据质量评分（0-1,默认1）
  "stationType": "string"          // 站点类型（tollgate/gantry）
}
```

#### OD数据格式

基于数据表 `dwd.dwd_od_g4202` 的数据结构：

```json
{
  "pass_id": "string",                    // 车辆通行记录ID
  "vehicle_type": "string",               // 车辆类型
  "start_time": "YYYY-MM-DD HH:MM:SS",    // 入口通行时间
  "start_square_code": "string",          // 入口收费站编码
  "start_square_name": "string",          // 入口收费站名称
  "start_station_code": "string",         // 入口车道编码
  "start_station_name": "string",         // 入口车道名称
  "end_time": "YYYY-MM-DD HH:MM:SS",      // 出口通行时间
  "end_square_code": "string",            // 出口收费站编码
  "end_square_name": "string",            // 出口收费站名称
  "end_station_code": "string",           // 出口车道编码
  "end_station_name": "string",           // 出口车道名称
  "direction": "string",                  // 行驶方向
  "tag": "string"                         // 标签信息
}
```

#### OD聚合数据格式

```json
{
  "od_pair_id": "string",                 // OD对ID (起点站点标识-终点站点标识)
  "start_station_id": "string",           // 起点站点标识（square_code或station_code）
  "end_station_id": "string",             // 终点站点标识（square_code或station_code）
  "start_station_type": "string",         // 起点站点类型（square/gantry）
  "end_station_type": "string",           // 终点站点类型（square/gantry）
  "od_type_combination": "string",        // OD类型组合（square-square/square-gantry/gantry-square/gantry-gantry）
  "time_hour": "number",                  // 小时时段 (0-23)
  "date": "YYYY-MM-DD",                   // 日期
  "weekday": "number",                    // 星期几 (1-7)
  "od_volume": "number",                  // OD流量 (veh/hour)
  "avg_travel_time": "number",            // 平均行程时间 (minutes)
  "data_quality": "number"                // 数据质量评分 (0-1)
}
```

### 处理流程

#### 3.1 时间特征提取

```
步骤1: 时间戳解析
- 提取小时时段 (0-23)
- 提取星期几 (1-7)
- 判断工作日/周末类型

步骤2: 时段标准化
- 将5分钟数据聚合为小时数据
- 计算小时平均流量
- 标记数据完整性
```

#### 3.2 历史数据聚合

```
步骤1: 数据筛选
- 选择30天历史窗口数据
- 过滤数据质量评分 < 0.7 的记录
- 排除异常值（3σ原则）

步骤2: 同期数据分组
- 按时段-星期组合分组
- 每组包含最多30个历史值
- 计算权重系数（时间衰减）
```

#### 3.3 OD数据预处理

```
步骤1: OD数据提取与聚合
- 从dwd.dwd_od_g4202表提取全部历史OD数据（约60天）
- 按小时时段聚合OD流量（基于start_time）
- 计算OD对平均行程时间（end_time - start_time）
- OD分两类：
  * 收费广场类型：square_code字段非空，使用square_code作为站点标识
  * 收费门架类型：square_code字段为空，使用station_code作为站点标识
- 生成统一的OD对标识（起点站点标识-终点站点标识）

SQL示例：
SELECT 
    CONCAT(
        COALESCE("start_square_code", "start_station_code"), 
        '-', 
        COALESCE("end_square_code", "end_station_code")
    ) as od_pair_id,
    COALESCE("start_square_code", "start_station_code") as start_station_id,
    COALESCE("end_square_code", "end_station_code") as end_station_id,
    CASE 
        WHEN "start_square_code" IS NOT NULL THEN 'square'
        ELSE 'gantry'
    END as start_station_type,
    CASE 
        WHEN "end_square_code" IS NOT NULL THEN 'square'
        ELSE 'gantry'
    END as end_station_type,
    EXTRACT(HOUR FROM "start_time") as time_hour,
    DATE("start_time") as date,
    EXTRACT(DOW FROM "start_time") as weekday,
    COUNT(*) as od_volume,
    AVG(EXTRACT(EPOCH FROM ("end_time" - "start_time"))/60) as avg_travel_time
FROM dwd.dwd_od_g4202
-- 使用全部约60天历史数据，无需WHERE时间筛选
GROUP BY od_pair_id, start_station_id, end_station_id, 
         start_station_type, end_station_type,
         time_hour, date, weekday

步骤2: OD数据质量评估
- 检查OD对数据完整性（起点终点站点标识非空）
- 验证行程时间合理性（5分钟-8小时范围）
- 识别异常OD流量（超过历史平均3倍）
- 计算OD数据质量评分
- 统计不同站点类型组合的OD分布

步骤3: OD对重要性分级
- 按历史平均流量对OD对分级（基于全部约60天数据）
  * 主要OD对：日均流量 > 100辆
  * 次要OD对：日均流量 50-100辆  
  * 一般OD对：日均流量 10-50辆
  * 稀疏OD对：日均流量 < 10辆
- 不同级别采用不同的基准计算策略
- 考虑站点类型组合对重要性级别的影响：
  * square-square: 广场到广场（主要干线）
  * square-gantry: 广场到门架（混合路径）
  * gantry-square: 门架到广场（混合路径）
  * gantry-gantry: 门架到门架（路段流量）
```

#### 3.4 基准流量计算

```
步骤1: 加权平均计算
For each (hour, weekday) combination:
  baseFlow = Σ(weight_i × flow_i) / Σ(weight_i)
  confidence = min(dataCount / 15, 1.0)  // 可信度评估

步骤2: 平滑处理
- 对相邻时段进行平滑处理
- 避免基准值突变
- 保持时段连续性
```

#### 3.5 OD基准流量计算

```
步骤1: 分层基准计算策略
根据OD对重要性级别和站点类型组合采用不同策略（全部基于约60天完整历史数据）：

站点类型组合优先级处理：
square-square（广场到广场）:
- 优先级最高，通常为主要干线OD对
- 采用最严格的数据要求和最高的权重

square-gantry / gantry-square（混合类型）:
- 中等优先级，可能涉及路径转换
- 适当放宽数据要求，采用中等权重

gantry-gantry（门架到门架）:
- 较低优先级，主要为路段内部流量
- 可采用相对宽松的数据要求

分级计算策略：
主要OD对（日均>100辆）:
- 使用全部约60天历史数据
- 按工作日/周末分别建立基准
- 采用时间衰减权重 + 站点类型权重
- 最小数据点要求：square-square≥30个，其他≥25个

次要OD对（日均50-100辆）:
- 使用全部约60天历史数据
- 工作日/周末合并建立基准
- 采用时间衰减权重 + 站点类型权重
- 最小数据点要求：square-square≥25个，其他≥20个

一般OD对（日均10-50辆）:
- 使用全部约60天历史数据
- 全时段合并建立基准
- 采用相似OD对辅助计算（优先同类型组合）
- 最小数据点要求：square-square≥20个，其他≥15个

稀疏OD对（日均<10辆）:
- 使用全部约60天历史数据
- 基于距离相似性和类型相似性插值
- 采用区域平均基准（按站点类型分组）
- 最小数据点要求：square-square≥12个，其他≥8个

步骤2: OD基准计算公式
For each OD pair (origin, destination, od_type):
  For each (hour, weekday) combination:
    baseODFlow = Σ(Wi × ODFlow_i) / Σ(Wi)
    
    权重计算：
    Wi = TimeWeight_i × SimilarityWeight × QualityWeight_i × TypeWeight
    
    TimeWeight_i = WEIGHT_DECAY_FACTOR^(days_ago_i)
    SimilarityWeight = exp(-distance(o,d)/DISTANCE_DECAY)  
    QualityWeight_i = data_quality_score_i
    TypeWeight = 根据站点类型组合的权重系数：
      - square-square: 1.0（基准权重）
      - square-gantry / gantry-square: 0.8
      - gantry-gantry: 0.6

步骤3: 基准可信度评估
- 数据充足性: dataCount >= MIN_OD_DATA_POINTS（按类型调整）
- 时间分布性: 数据覆盖时间窗口 >= 50%
- 变异稳定性: CV(OD流量) <= 1.5
- 类型一致性: 同类型组合的OD对相关性 > 0.6
- 整体可信度: confidence = min(1.0, (dataCount/MIN_OD_DATA_POINTS) × (coverage/0.5) × (1.5/CV) × TypeWeight)

步骤4: 相似OD对辅助计算（用于稀疏OD对）
- 优先识别相同站点类型组合的OD对
- 其次考虑地理位置相近的OD对（距离阈值：20km）
- 计算加权平均基准模式（类型权重 + 地理权重）
- 按距离权重和类型权重进行基准插值
- 设置辅助计算标识和置信度折扣（×0.7）
```

#### 3.6 异常值过滤

```
步骤1: 统计特征计算
- 计算均值μ和标准差σ
- 确定异常值边界 [μ-3σ, μ+3σ]

步骤2: 异常值处理
- 标记超出边界的数据点
- 使用相邻正常值插值替代
- 更新数据质量评分
```

### 输出结果格式

#### 基础流量基准输出格式

关系数据库表存储，行格式：
baseflow_pattern_id, station_square_code,gantry_code,code_type,pattern_type,hour,baseflow_avg,...confidence

code_type: gantry,square

pattern_type:weekday,weekend,holiday_free,holiday_nofree,monday ... sunday

```json
{
  "stationId": "string",
  "baseFlowPattern": {
    "weekday": [                    // 工作日基准模式 (0-23小时)
      {"hour": 0, "baseFlow": 120.5, "confidence": 0.85},
      {"hour": 1, "baseFlow": 95.2, "confidence": 0.82},
      // ... 24个时段
    ],
    "weekend": [                    // 周末基准模式 (0-23小时)
      {"hour": 0, "baseFlow": 85.3, "confidence": 0.78},
      // ... 24个时段
    ]
  },
  "updateTime": "YYYY-MM-DD HH:MM:SS",
  "dataWindow": "30days",
  "overallQuality": 0.83
}
```

#### OD基准流量输出格式

关系数据库表存储，表结构：
```sql
CREATE TABLE od_baseflow_pattern (
    pattern_id VARCHAR(100) PRIMARY KEY,
    od_pair_id VARCHAR(200) NOT NULL,
    start_station_id VARCHAR(100) NOT NULL,      -- 起点站点标识（square_code或station_code）
    end_station_id VARCHAR(100) NOT NULL,        -- 终点站点标识（square_code或station_code）
    start_station_type VARCHAR(20) NOT NULL,     -- 起点站点类型（square/gantry）
    end_station_type VARCHAR(20) NOT NULL,       -- 终点站点类型（square/gantry）
    od_type_combination VARCHAR(30) NOT NULL,    -- OD类型组合（square-square等）
    pattern_type VARCHAR(50) NOT NULL,           -- weekday/weekend/holiday
    hour INTEGER NOT NULL,                       -- 0-23
    base_od_flow DECIMAL(10,2) NOT NULL,
    confidence DECIMAL(3,2) NOT NULL,
    od_importance_level VARCHAR(20),             -- major/minor/normal/sparse
    calculation_method VARCHAR(50),              -- direct/similarity/regional
    data_points_count INTEGER,
    avg_travel_time DECIMAL(6,2),
    type_weight DECIMAL(3,2),                    -- 站点类型权重
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_od_pattern UNIQUE(od_pair_id, pattern_type, hour),
    INDEX idx_od_type_combination (od_type_combination),
    INDEX idx_station_type (start_station_type, end_station_type)
);
```

JSON格式输出：
```json
{
  "odPairId": "STA001-STA002",
  "startStationId": "STA001",
  "endStationId": "STA002",
  "startStationType": "square",           // square/gantry
  "endStationType": "square",             // square/gantry
  "odTypeCombination": "square-square",   // square-square/square-gantry/gantry-square/gantry-gantry
  "baseODPattern": {
    "weekday": [
      {
        "hour": 0, 
        "baseODFlow": 25.3, 
        "confidence": 0.82,
        "avgTravelTime": 45.2,
        "dataPointsCount": 18,
        "calculationMethod": "direct",
        "typeWeight": 1.0
      },
      // ... 24个时段
    ],
    "weekend": [
      {
        "hour": 0, 
        "baseODFlow": 18.7, 
        "confidence": 0.75,
        "avgTravelTime": 42.8,
        "dataPointsCount": 12,
        "calculationMethod": "direct",
        "typeWeight": 1.0
      },
      // ... 24个时段
    ]
  },
  "odImportanceLevel": "major",        // major/minor/normal/sparse
  "updateTime": "YYYY-MM-DD HH:MM:SS",
  "dataWindow": "~60days",
  "overallQuality": 0.78
}
```

### 关键判别条件

#### 基础流量基准判别条件
- **数据充足性判断**: 每个时段至少需要15个有效历史数据点
- **可信度阈值**: 基准可信度 ≥ 0.6 才可用于后续计算
- **更新频率**: 每日凌晨2:00更新基准模式
- **质量控制**: 整体数据质量 < 0.5 时触发告警

#### OD基准流量判别条件
- **分层数据充足性要求**: 
  * 主要OD对：square-square≥30个，其他类型≥25个数据点
  * 次要OD对：square-square≥25个，其他类型≥20个数据点  
  * 一般OD对：square-square≥20个，其他类型≥15个数据点
  * 稀疏OD对：square-square≥12个，其他类型≥8个数据点
- **OD可信度阈值**: 
  * 直接计算：confidence ≥ 0.6
  * 相似性插值：confidence ≥ 0.4
  * 区域平均：confidence ≥ 0.3
- **站点类型权重影响**: square-square类型基准可信度最高，gantry-gantry类型需适当降低可信度要求
- **数据时间覆盖度**: 历史数据覆盖时间窗口 ≥ 50%
- **行程时间合理性**: 5分钟 ≤ 平均行程时间 ≤ 8小时
- **OD流量变异系数**: CV ≤ 1.5（过大则降低可信度）
- **类型一致性检查**: 同类型组合的OD对相关性 > 0.6
- **更新频率**: 每日凌晨3:00更新OD基准模式（在基础流量基准后）
- **质量控制**: OD整体数据质量 < 0.4 时触发告警
- **数据窗口**: 使用约60天完整历史数据，无需滚动更新

---

## 4. 参数设置

### 关键参数定义

#### 基础流量基准参数

| 参数名称             | 默认值 | 取值范围 | 说明               |
| -------------------- | ------ | -------- | ------------------ |
| HISTORY_WINDOW       | 30天   | 15-90天  | 历史数据窗口长度   |
| MIN_DATA_POINTS      | 15     | 10-30    | 每时段最少数据点数 |
| QUALITY_THRESHOLD    | 0.7    | 0.5-0.9  | 数据质量过滤阈值   |
| CONFIDENCE_THRESHOLD | 0.6    | 0.4-0.8  | 基准可信度阈值     |
| WEIGHT_DECAY_FACTOR  | 0.95   | 0.8-0.99 | 时间权重衰减系数   |
| OUTLIER_SIGMA        | 3.0    | 2.0-4.0  | 异常值检测σ倍数   |

#### OD基准流量参数

| 参数名称                   | 默认值  | 取值范围    | 说明                     |
| -------------------------- | ------- | ----------- | ------------------------ |
| OD_HISTORY_WINDOW          | 约60天  | 全部数据    | 所有OD对统一历史窗口     |
| MIN_OD_DATA_MAJOR_SQUARE   | 30      | 25-40       | 主要square-square最少数据点 |
| MIN_OD_DATA_MAJOR_OTHER    | 25      | 20-35       | 主要其他类型最少数据点   |
| MIN_OD_DATA_MINOR_SQUARE   | 25      | 20-30       | 次要square-square最少数据点 |
| MIN_OD_DATA_MINOR_OTHER    | 20      | 15-25       | 次要其他类型最少数据点   |
| MIN_OD_DATA_NORMAL_SQUARE  | 20      | 15-25       | 一般square-square最少数据点 |
| MIN_OD_DATA_NORMAL_OTHER   | 15      | 10-20       | 一般其他类型最少数据点   |
| MIN_OD_DATA_SPARSE_SQUARE  | 12      | 8-16        | 稀疏square-square最少数据点 |
| MIN_OD_DATA_SPARSE_OTHER   | 8       | 5-12        | 稀疏其他类型最少数据点   |
| TYPE_WEIGHT_SQUARE_SQUARE  | 1.0     | 0.8-1.2     | square-square类型权重    |
| TYPE_WEIGHT_MIXED          | 0.8     | 0.6-1.0     | 混合类型权重             |
| TYPE_WEIGHT_GANTRY_GANTRY  | 0.6     | 0.4-0.8     | gantry-gantry类型权重    |
| OD_CONFIDENCE_DIRECT       | 0.6     | 0.4-0.8     | 直接计算可信度阈值       |
| OD_CONFIDENCE_SIMILARITY   | 0.4     | 0.2-0.6     | 相似性计算可信度阈值     |
| OD_CONFIDENCE_REGIONAL     | 0.3     | 0.1-0.5     | 区域平均可信度阈值       |
| DISTANCE_DECAY             | 50      | 20-100      | 距离衰减参数(km)         |
| SIMILARITY_RADIUS          | 20      | 10-50       | 相似OD对搜索半径(km)     |
| MAX_TRAVEL_TIME            | 480     | 240-720     | 最大合理行程时间(分钟)   |
| MIN_TRAVEL_TIME            | 5       | 2-10        | 最小合理行程时间(分钟)   |
| OD_CV_THRESHOLD            | 1.5     | 1.0-2.0     | OD流量变异系数阈值       |
| OD_MAJOR_THRESHOLD         | 100     | 50-200      | 主要OD对日均流量阈值     |
| OD_MINOR_THRESHOLD         | 50      | 25-100      | 次要OD对日均流量阈值     |
| OD_NORMAL_THRESHOLD        | 10      | 5-25        | 一般OD对日均流量阈值     |

### 参数取值依据

- **HISTORY_WINDOW**: 基于交通流量周期性特征，30天可覆盖月度变化
- **MIN_DATA_POINTS**: 统计学要求，确保基准计算的统计显著性
- **QUALITY_THRESHOLD**: 数据质量控制，平衡数据可用性和准确性
- **WEIGHT_DECAY_FACTOR**: 时间衰减模型，近期数据权重更高
- **OD_HISTORY_WINDOW**: OD数据为约60天完整历史数据，无需筛选，统一使用全部数据
- **MIN_OD_DATA_***: 基于约60天数据量和站点类型特征调整，确保各级别OD对有足够样本进行统计分析
- **TYPE_WEIGHT_***: 基于站点类型的业务重要性设定权重，square-square为主干线权重最高，gantry-gantry为路段内部流量权重较低
- **DISTANCE_DECAY**: 基于高速公路网络特征，50km为合理的相似性衰减距离
- **SIMILARITY_RADIUS**: 相似OD对搜索半径，考虑收费站分布密度设定

### 参数调整策略

```
自适应调整规则:
1. 数据稀少场景: 降低MIN_DATA_POINTS至10
2. 数据质量差: 提高QUALITY_THRESHOLD至0.8
3. 季节性变化: 扩大HISTORY_WINDOW至60天
4. 实时性要求高: 缩短HISTORY_WINDOW至15天

OD参数调整规则:
1. OD数据稀少场景: 适当降低各级别MIN_OD_DATA要求
2. OD数据质量差: 提高相似性权重，更多依赖空间插值
3. 新路网变化: 临时扩大SIMILARITY_RADIUS至30km
4. 历史窗口固定: OD_HISTORY_WINDOW保持约60天不变，使用全部可用数据确保一致性
```

---

## 5. 边界条件

### 异常数据处理

#### 基础流量异常处理

```
场景1: 历史数据不足
- 条件: 有效数据点 < MIN_DATA_POINTS
- 处理: 使用全时段平均值作为临时基准
- 标记: 设置confidence = 0.3

场景2: 数据质量过低
- 条件: 整体数据质量 < 0.5
- 处理: 延用上一次有效基准，标记为降级模式
- 告警: 发送数据质量告警

场景3: 异常值过多
- 条件: 异常值比例 > 30%
- 处理: 使用中位数替代均值计算
- 调整: 临时放宽OUTLIER_SIGMA至4.0
```

#### OD数据异常处理

```
场景1: OD数据不足
- 主要OD对数据不足: 降级为次要OD对处理策略
- 次要OD对数据不足: 降级为一般OD对处理策略  
- 一般OD对数据不足: 降级为稀疏OD对处理策略
- 稀疏OD对数据不足: 使用相似OD对或区域平均基准

场景2: 行程时间异常
- 条件: 行程时间 < 5分钟 或 > 8小时
- 处理: 标记为异常记录，从基准计算中排除
- 记录: 记录异常比例，超过20%时触发告警

场景3: OD流量突变
- 条件: 单日OD流量超过历史平均3倍
- 处理: 标记为异常值，使用3σ原则处理
- 验证: 检查是否为实际交通事件导致

场景4: 缺失OD对
- 新出现OD对: 初始设置为稀疏级别，逐步积累数据
- 历史OD对消失: 保留最后有效基准30天，标记为过期
- 系统性缺失: 检查数据采集系统状态

场景5: 重复OD记录
- 条件: 同一pass_id在同一时段出现多次
- 处理: 按时间顺序保留最新记录
- 标记: 更新数据质量评分，降低权重
```

### 边界情况处理

#### 基础流量边界处理

```
新站点冷启动:
- 无历史数据时使用同类型站点典型模式
- 逐步积累数据，动态调整基准
- 设置学习期标识，降低基准权重

节假日处理:
- 识别法定节假日和特殊时期
- 单独建立节假日基准模式
- 避免节假日数据污染日常基准

系统维护期:
- 识别系统维护和设备故障期间
- 排除维护期数据参与基准计算
- 使用备用基准维持服务连续性
```

#### OD数据边界处理

```
新收费站开通:
- 初期使用邻近站点OD分布模式
- 设置3个月学习期，逐步建立独有基准
- 基于地理位置和路网特征预估初始模式

收费站临时关闭:
- 识别临时关闭期间（如施工、维护）
- 排除关闭期间数据，避免影响基准计算
- 重开后使用关闭前基准，逐步更新

免费通行期间:
- 识别节假日免费通行时段
- 单独建立免费期OD基准模式
- 避免免费数据污染收费期基准

特殊天气影响:
- 识别极端天气导致的OD流量异常
- 标记天气异常期间数据
- 可选择性排除或单独处理

路网结构变化:
- 检测新路段开通对OD分布的影响
- 识别路径变化导致的OD模式变化
- 渐进式调整基准，避免突变

跨区域长距离OD:
- 识别超长距离OD对（>500km）
- 单独处理，避免影响区域内OD基准
- 考虑途径多个收费站的复合路径
```

### 容错机制

```
计算失败容错:
- 基准计算异常时使用历史基准
- 设置最大容错次数(3次)
- 超限后切换到安全模式

内存溢出保护:
- 限制历史数据缓存大小
- 采用滑动窗口机制
- 定期清理过期数据

并发访问控制:
- 基准更新时加锁保护
- 读写分离，避免计算阻塞
- 异步更新机制
```

---

## 6. 性能评估

### 评估指标

#### 基础流量准确性指标

- **基准偏差率**: |实际流量 - 基准流量| / 基准流量 < 20%
- **趋势一致性**: 基准趋势与实际趋势相关系数 > 0.8
- **可信度分布**: 高可信度(>0.8)时段占比 > 70%

#### OD基准准确性指标

- **OD基准偏差率**: |实际OD流量 - 基准OD流量| / 基准OD流量 < 25%
- **OD趋势一致性**: OD基准趋势与实际趋势相关系数 > 0.75
- **OD覆盖率**: 建立有效基准的OD对占总活跃OD对比例 > 80%
- **分层准确性**: 
  * 主要OD对偏差率 < 15%
  * 次要OD对偏差率 < 20%
  * 一般OD对偏差率 < 25%
  * 稀疏OD对偏差率 < 35%
- **行程时间准确性**: |实际行程时间 - 基准行程时间| / 基准行程时间 < 30%

#### 时效性指标

- **计算延迟**: 基准更新计算时间 < 10秒
- **OD计算延迟**: OD基准更新计算时间 < 30秒
- **数据新鲜度**: 基准数据更新延迟 < 1小时
- **响应时间**: 基准查询响应时间 < 100ms
- **OD响应时间**: OD基准查询响应时间 < 200ms

#### 稳定性指标

- **基准稳定性**: 相邻更新周期基准变化率 < 10%
- **OD基准稳定性**: 相邻更新周期OD基准变化率 < 15%
- **异常处理率**: 异常情况处理成功率 > 95%
- **系统可用性**: 基准服务可用性 > 99%
- **OD数据质量**: OD数据清洗后质量评分 > 0.8

### 测试方法

```
历史回测验证:
1. 选择3个月历史数据
2. 使用前30天建立基准
3. 验证后60天基准准确性
4. 统计各项评估指标

实时验证:
1. 部署到测试环境
2. 并行运行30天
3. 对比专家经验基准
4. 收集用户反馈评价

压力测试:
1. 模拟高并发访问
2. 测试大数据量处理
3. 验证异常场景处理
4. 评估系统稳定性
```

### 预期性能

- 基准偏差率 < 15%（目标值）
- 趋势一致性 > 0.85（目标值）
- 计算延迟 < 8秒（目标值）
- 系统可用性 > 99.5%（目标值）

---

## 7. 实现要点

### 关键技术点

#### 基础流量处理技术点
1. **时间序列处理**: 高效的时间窗口滑动和数据聚合
2. **权重计算**: 时间衰减权重的精确计算
3. **内存管理**: 大量历史数据的内存优化
4. **并发控制**: 多站点并行计算的资源管理

#### OD数据处理技术点
1. **大规模OD数据聚合**: 高效的分布式聚合算法，支持千万级OD记录处理
2. **空间索引优化**: 基于地理位置的R-tree或GeoHash索引，支持相似OD对快速检索
3. **分层计算策略**: 根据OD重要性级别分配不同计算资源
4. **流式数据处理**: 实时OD数据流处理和增量基准更新
5. **缓存分层设计**: 
   - L1缓存：热点OD对基准数据（内存）
   - L2缓存：常用OD对基准数据（Redis）  
   - L3存储：全量OD基准数据（数据库）
6. **相似性计算优化**: 预计算收费站间距离矩阵，支持快速相似度检索

### 性能优化建议

#### 基础流量优化
1. **数据预聚合**: 预先按时段-星期维度聚合数据
2. **缓存机制**: 缓存计算结果，减少重复计算
3. **批处理**: 批量更新多个站点基准
4. **索引优化**: 优化时间范围查询索引

#### OD数据优化
1. **分区策略**: 按收费站或区域对OD数据进行分区存储
2. **并行计算**: 
   - OD对级别并行：同时计算多个OD对的基准
   - 时段级别并行：同时计算多个时段的基准
   - 模式级别并行：同时计算工作日/周末模式
3. **增量更新**: 
   - 仅更新发生变化的OD对基准
   - 基于数据变化阈值触发更新
   - 支持部分OD对的热更新
4. **内存池管理**: 预分配内存池，避免频繁内存分配释放
5. **SQL优化**: 
   ```sql
   -- 使用窗口函数优化OD聚合查询
   WITH od_hourly AS (
     SELECT 
       CONCAT("start_square_code", '-', "end_square_code") as od_pair_id,
       "start_square_code", "end_square_code",
       DATE_TRUNC('hour', "start_time") as hour_time,
       COUNT(*) as hourly_volume
     FROM dwd.dwd_od_g4202 
     -- 使用全部约60天历史数据，无需WHERE时间筛选
     GROUP BY 1,2,3,4
   )
   SELECT 
     od_pair_id,
     EXTRACT(HOUR FROM hour_time) as hour,
     EXTRACT(DOW FROM hour_time) as weekday,
     AVG(hourly_volume) as base_flow
   FROM od_hourly
   GROUP BY od_pair_id, EXTRACT(HOUR FROM hour_time), EXTRACT(DOW FROM hour_time)
   ```
6. **数据压缩**: 对历史OD数据进行列式压缩存储，减少I/O开销
7. **智能预热**: 系统启动时预先加载热点OD对基准数据到缓存

### 监控告警

#### 基础流量监控告警
1. **计算异常告警**: 基准计算失败或超时
2. **数据质量告警**: 数据质量持续下降
3. **性能告警**: 计算延迟超过阈值
4. **业务告警**: 基准异常偏差超限

#### OD数据监控告警
1. **OD数据量异常告警**: 
   - 日OD数据量相比历史平均下降>30%
   - 重要OD对连续缺失>2小时
   - 新异常OD对出现（超长距离、超短时间等）

2. **OD计算性能告警**:
   - OD基准计算时间超过30秒
   - OD相似性检索时间超过5秒
   - OD数据聚合内存使用超过阈值

3. **OD基准质量告警**:
   - OD基准可信度低于阈值的OD对比例>20%
   - 主要OD对基准连续异常>24小时
   - OD行程时间基准偏差持续>50%

4. **OD系统状态告警**:
   - OD基准更新失败
   - OD缓存命中率<60%
   - OD数据分区存储空间不足

5. **OD业务逻辑告警**:
   - 检测到路网结构变化影响OD分布
   - 异常天气或事件导致OD模式突变
   - 收费政策变化影响OD流量分布

---

**文档状态**: 设计完成
**审核状态**: 待审核
**实现状态**: 待开发
**测试状态**: 待测试

**变更记录**:

- v1.0 (2025-06-17): 初始设计文档创建
- v1.1 (2025-06-09): 补充OD数据历史基准建立功能
  - 新增OD数据处理流程和算法逻辑
  - 新增OD基准计算分层策略
  - 新增OD相关参数设置和边界条件处理
  - 新增OD性能评估指标和监控告警机制
  - 优化数据库表结构和查询性能
- v1.2 (2025-06-19): 新增站点类型差异化处理
  - 增加收费广场(square)和收费门架(gantry)的区分处理
  - 新增站点类型组合的权重机制和分层策略
  - 优化OD对标识生成和相似性计算算法
  - 完善数据库表结构和输出格式
