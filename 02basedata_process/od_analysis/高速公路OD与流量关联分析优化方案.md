# 高速公路OD与流量关联分析优化方案

## 📋 概述

本文档描述了高速公路OD数据与流量数据关联分析的优化方案，重点解决门架途中流量和收费广场进出流量的准确对比分析问题。

## 🎯 核心问题分析

### 1. 门架流量特征

**门架位置特点**：
- 位于高速公路的两个收费站或两个互通枢纽中间
- 存在互通枢纽转出或转入目标高速的车辆

**门架流量构成**：
- **OD相关流量**：以该门架为起点(O)或终点(D)的车辆
- **途中流量**：经过该门架但起止点都不在该门架的车辆
  - 过境车辆：从其他高速转入目标高速，经过该门架，最终驶出到其他高速
  - 中途车辆：起止点都在目标高速公路上，但该门架只是途经点

**关键特征**：
```
门架总流量 = OD相关流量 + 途中流量
途中流量 >> OD相关流量（通常情况）
```

### 2. 收费广场流量特征

**收费广场位置特点**：
- 高速公路的明确进入点或驶出点
- 是OD数据中的起点(O)或终点(D)

**收费广场流量构成**：
- **入口流量**：应与以该收费广场为起点(O)的OD统计量高度一致
- **出口流量**：应与以该收费广场为终点(D)的OD统计量高度一致

**关键特征**：
```
收费广场入口流量 ≈ 收费广场为O点的OD量
收费广场出口流量 ≈ 收费广场为D点的OD量
```

## 🔄 优化方案

### 1. 数据源映射

| 分析对象 | 流量数据源 | OD数据源 | 对比关系 |
|---------|-----------|----------|----------|
| 门架起点 | `dwd.dwd_flow_gantry_weekly` | 门架为O点的OD数据 | 存在大量途中流量 |
| 门架终点 | `dwd.dwd_flow_gantry_weekly` | 门架为D点的OD数据 | 存在大量途中流量 |
| 收费广场入口 | `dwd.dwd_flow_onramp_weekly` | 收费广场为O点的OD数据 | 高度一致 |
| 收费广场出口 | `dwd.dwd_flow_offramp_weekly` | 收费广场为D点的OD数据 | 高度一致 |

### 2. 关键指标定义

#### 2.1 门架分析指标

```python
# 门架OD相关流量
门架OD流量 = 门架为O点的OD量 + 门架为D点的OD量

# 门架途中流量
门架途中流量 = 门架总流量 - 门架OD流量

# 门架OD占比
门架OD占比 = 门架OD流量 / 门架总流量

# 门架途中流量占比
门架途中流量占比 = 门架途中流量 / 门架总流量 = 1 - 门架OD占比
```

#### 2.2 收费广场分析指标

```python
# 收费广场入口一致性
入口一致性比值 = 收费广场入口流量 / 收费广场为O点的OD量

# 收费广场出口一致性
出口一致性比值 = 收费广场出口流量 / 收费广场为D点的OD量

# 收费广场流量平衡
流量平衡比值 = 收费广场出口流量 / 收费广场入口流量
```

### 3. 分析维度扩展

#### 3.1 门架分析（新增）

**当前分析**：
- 门架作为起点与门架流量的关联

**新增分析**：
- 门架作为终点与门架流量的关联
- 门架途中流量分析
- 门架交通功能评估（起止点功能 vs 通道功能）

#### 3.2 收费广场分析（新增）

**当前分析**：
- 收费广场作为起点与上匝道流量的关联

**新增分析**：
- 收费广场作为终点与下匝道流量的关联
- 收费广场进出流量平衡分析
- 收费广场一致性评估

## 📊 分析报告结构

### 1. 门架关联分析

#### 1.1 门架起点分析
- 基本统计：关联记录数、涉及门架数、相关系数
- OD/流量比分布统计
- 车型结构对比
- 时间模式分析

#### 1.2 门架终点分析（新增）
- 门架作为终点的OD统计
- 门架终点流量关联分析
- 终点vs起点的流量特征对比

#### 1.3 门架途中流量分析（新增）
- 途中流量占比统计
- 不同门架的途中流量特征
- 门架交通功能分类（通道型 vs 起止型）

### 2. 收费广场关联分析

#### 2.1 收费广场入口分析
- 入口流量与O点OD量的关联分析
- 一致性评估（期望比值接近1）
- 时间模式和车型结构分析

#### 2.2 收费广场出口分析（新增）
- 出口流量与D点OD量的关联分析
- 一致性评估（期望比值接近1）
- 出口vs入口的流量特征对比

#### 2.3 收费广场流量平衡分析（新增）
- 进出流量平衡统计
- 异常收费广场识别（进出流量严重不平衡）
- 流量平衡的时间变化模式

### 3. 对比分析

#### 3.1 门架vs收费广场功能差异
- OD占比对比（收费广场应接近100%，门架通常较低）
- 一致性指标对比
- 交通功能定位差异

#### 3.2 途中流量影响分析
- 途中流量对关联分析结果的影响
- 不同类型设施的流量特征差异
- 优化建议

## 🔧 技术实现要点

### 1. 数据加载优化
- 分别加载上匝道和下匝道流量数据
- 区分门架的起点和终点OD数据
- 优化SQL查询性能

### 2. 计算逻辑增强
- 实现途中流量计算算法
- 增加一致性评估指标
- 完善异常值检测

### 3. 报告生成改进
- 增加新的分析章节
- 优化图表展示
- 增强数据可视化

## 📈 预期效果

### 1. 分析准确性提升
- 正确理解门架途中流量的影响
- 准确评估收费广场的一致性
- 避免误解流量差异的原因

### 2. 业务洞察增强
- 识别不同设施的交通功能定位
- 发现异常流量模式
- 支持交通管理决策

### 3. 数据质量评估
- 评估OD数据的完整性
- 识别流量数据的异常
- 提供数据质量改进建议

## 🎯 实施计划

1. **第一阶段**：代码框架调整，增加新的分析模块
2. **第二阶段**：实现途中流量计算和收费广场出口分析
3. **第三阶段**：完善报告生成和数据可视化
4. **第四阶段**：测试验证和性能优化

---

*本文档版本：v1.0*  
*更新时间：2025-07-18*
