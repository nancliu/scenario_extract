# 高速公路OD与流量关联分析总结报告

## 📋 项目概述

### 项目背景
本项目旨在深入分析高速公路OD（Origin-Destination）数据与流量数据之间的关联性，重点解决门架途中流量和收费广场进出流量的准确对比分析问题。

### 分析目标
1. 验证门架主要承担通道功能的理论假设
2. 验证收费广场流量与OD数据高度一致的理论假设
3. 分析OD/流量比中位数约50%的差异原因
4. 建立科学的交通数据质量评估体系

### 版本更新说明
- **v2.0**：支持2024年和2025年数据自动切换
- **v2.0**：修复收费广场出口分析数据不一致问题
- **v2.0**：优化数据质量评估机制
- **v2.0**：移除无意义的平均进出流量比计算

## 🔧 技术实现

### 数据源适配
系统现已支持跨年份数据分析：

#### 2025年数据表
- **OD数据**：`dwd.dwd_od_weekly`
- **门架流量**：`dwd.dwd_flow_gantry_weekly`
- **收费广场入口流量**：`dwd.dwd_flow_onramp_weekly`
- **收费广场出口流量**：`dwd.dwd_flow_offramp_weekly`

#### 2024年数据表
- **OD数据**：`dwd.dwd_od_g4202`
- **门架流量**：`dwd.dwd_flow_gantry`
- **收费广场入口流量**：`dwd.dwd_flow_onramp`
- **收费广场出口流量**：`dwd.dwd_flow_offramp`

### 关键技术改进

#### 1. 年份自动检测
```python
def _is_2024_data(self, start_date: str) -> bool:
    """自动检测数据年份，选择对应表结构"""
    return datetime.strptime(start_date, '%Y-%m-%d %H:%M:%S').year == 2024
```

#### 2. 字段适配机制
```python
# 2024年表需要计算总流量和车型分组
if self._is_2024_data(start_date):
    # 门架表：gantry_id -> station_code
    # 计算总流量：(k1+k2+k3+k4+h1+h2+h3+h4+h5+h6+t1+t2+t3+t4+t5+t6)
    # 计算车型：total_k, total_h, total_t
else:
    # 2025年表直接使用预计算字段
```

#### 3. 数据时间过滤优化
- **收费广场入口分析**：基于 `start_time` 过滤，分析在指定时间开始的行程
- **收费广场出口分析**：基于 `end_time` 过滤，分析在指定时间结束的行程
- **数据合并去重**：使用 `pass_id` 确保数据完整性

### 核心功能模块
1. **门架关联分析**
   - 门架起点分析：统计以门架为起点的OD数据与门架流量的关联
   - 门架终点分析：统计以门架为终点的OD数据与门架流量的关联
   - 门架途中流量分析：计算门架的途中流量占比和功能分类

2. **收费广场关联分析**
   - 收费广场入口分析：统计以收费广场为起点的OD数据与入口流量的关联
   - 收费广场出口分析：统计以收费广场为终点的OD数据与出口流量的关联
   - 收费广场流量平衡分析：分析进出流量的平衡情况

3. **深度案例分析**
   - 中位数案例分析：深入分析OD/流量比中位数附近的具体案例
   - 车型结构对比：对比OD数据与流量数据的车型分布差异
   - 异常模式识别：识别流量平衡异常的收费广场

### 关键算法
```python
# 门架途中流量计算
途中流量 = 门架总流量 - (门架为O点的OD量 + 门架为D点的OD量)
途中流量占比 = 途中流量 / 门架总流量

# 收费广场一致性评估
入口一致性比值 = 收费广场入口流量 / 收费广场为O点的OD量
出口一致性比值 = 收费广场出口流量 / 收费广场为D点的OD量

# 门架功能分类
if OD占比 > 0.5: 功能类型 = "起止型"
elif 途中流量占比 > 0.8: 功能类型 = "通道型"  
else: 功能类型 = "混合型"
```

## 📊 分析结果

### 数据规模（1小时样本：2025-07-07 08:00-09:00）
- **入口分析OD数据**：100,240条记录
- **出口分析OD数据**：105,513条记录
- **合并后OD数据**：约18万条记录（去重后）
- **门架流量数据**：2,690条记录
- **收费广场入口流量**：1,632条记录
- **收费广场出口流量**：1,614条记录

### 核心发现

#### 1. 门架途中流量验证 ✅
- **途中流量占比**：84.3%
- **OD相关流量占比**：28.9%
- **门架功能分类**：
  - 通道型：163个（71.8%）
  - 混合型：46个（20.3%）
  - 起止型：18个（7.9%）

**结论**：验证了门架主要承担通道功能的理论假设，通道型门架占绝大多数。

#### 2. 收费广场一致性验证 ✅
- **入口相关系数**：0.993（高度一致）
- **出口相关系数**：0.990（高度一致）
- **入口平均OD/流量比**：0.873（87.3%）
- **入口中位数OD/流量比**：0.924（92.4%）
- **出口平均OD/流量比**：0.817（81.7%）
- **出口中位数OD/流量比**：0.861（86.1%）

**结论**：验证了收费广场流量与OD数据高度一致的理论假设。

#### 3. 数据质量问题修复 🔧

**问题发现**：
- 原始报告中收费广场出口分析的基本统计显示中位数为0.000
- 中位数案例分析显示中位数为0.581
- 数据库直接查询结果与分析结果不一致

**问题根因**：
1. **时间过滤逻辑错误**：出口分析应基于 `end_time` 而非 `start_time`
2. **数据连接方式问题**：left join导致大量0值影响统计
3. **统计计算基准不一致**：部分基于全量数据，部分基于有效数据

**解决方案**：
1. **分离数据加载**：入口和出口分析使用不同的时间过滤条件
2. **统一统计基准**：统计指标只基于有效匹配的数据计算
3. **数据质量评估**：区分总OD记录数和有效匹配记录数

#### 4. 86%差异原因分析 🔍

通过修复后的中位数案例深度分析发现：

**典型案例分析**：
- **入口中位数案例**：中位数OD/流量比为0.924（92.4%）
- **出口中位数案例**：中位数OD/流量比为0.861（86.1%）
- **差异范围**：入口比出口高约6个百分点

**根本原因**：
1. **时间窗口差异**：入口分析基于start_time，出口分析基于end_time
2. **流量检测完整性**：出口检测可能受到多种因素影响
3. **数据处理一致性**：两个方向的数据处理逻辑略有差异
4. **ETC设备性能**：不同位置设备的捕获率可能存在差异

## 📈 业务价值

### 1. 交通管理优化
- **门架管理策略**：
  - 重点监控163个通道型门架的流量变化
  - 对46个混合型门架进行差异化管理
  - 特别关注18个起止型门架的特殊功能

- **收费广场管理策略**：
  - 入口：利用87-92%的一致性进行流量预测
  - 出口：利用82-86%的一致性进行容量规划
  - 建立进出流量平衡监控机制（基于中位数0.930）

### 2. 数据质量评估体系
- **OD数据质量指标**：
  - 收费广场入口OD/流量比：85%-95%
  - 收费广场出口OD/流量比：80%-90%
  - 门架OD占比：20%-35%

- **异常检测机制**：
  - 入口OD/流量比偏离92%超过15%时预警
  - 出口OD/流量比偏离86%超过15%时预警
  - 门架途中流量占比低于75%时检查

### 3. 预测模型优化
- **入口流量预测模型**：使用0.92转换系数从OD数据预测流量
- **出口流量预测模型**：使用0.86转换系数从OD数据预测流量
- **拥堵预警模型**：基于OD/流量比异常变化预警
- **容量规划模型**：基于途中流量占比规划道路容量

## 🔍 日常应用指南

### 每日监控指标
1. **收费广场入口OD/流量比**：是否在85%-95%范围内
2. **收费广场出口OD/流量比**：是否在80%-90%范围内
3. **门架途中流量占比**：是否在75%-90%范围内
4. **异常收费广场数量**：进出流量严重不平衡的数量（当前约97.6%）

### 跨年份数据分析
- **2024年数据**：使用历史数据表，系统自动适配字段结构
- **2025年数据**：使用当前数据表，直接使用预计算字段
- **混合分析**：可以分别分析不同年份数据，对比趋势变化

### 周期性分析
- **每周**：分析门架功能分类变化趋势
- **每月**：评估OD数据质量改进效果
- **每季度**：更新流量预测模型参数
- **每年**：对比年度数据差异，更新基准值

### 异常处理流程
1. **数据一致性异常**：
   - 入口OD/流量比偏离92%超过15% → 检查ETC设备和数据传输
   - 出口OD/流量比偏离86%超过15% → 分析交通模式变化

2. **门架功能异常**：
   - 途中流量占比突然下降到75%以下 → 检查新增起止点
   - 混合型门架OD占比突增超过50% → 分析交通模式变化

3. **收费广场平衡异常**：
   - 进出流量比偏离0.93超过30% → 调查设备故障
   - 持续不平衡收费广场增加 → 分析是否有单向交通模式

## 📋 技术规范

### 数据处理标准
1. **时间窗口**：建议使用1小时作为标准分析单位
2. **样本大小**：单小时数据量通常在10-18万条OD记录
3. **关联逻辑**：
   - 收费广场入口：O点在收费广场，基于start_time过滤
   - 收费广场出口：D点在收费广场，基于end_time过滤
   - 门架分析：同时考虑起点和终点功能

### 质量控制要求
1. **数据完整性**：确保OD数据和流量数据时间范围一致
2. **字段标准化**：统一车型分类标准，支持跨年份适配
3. **异常值处理**：过滤明显异常的OD/流量比（如>2.0或<0.1）
4. **统计基准一致**：所有关键指标基于有效匹配数据计算

### 年份兼容性
1. **自动检测**：系统根据日期自动选择对应年份的数据表
2. **字段映射**：自动处理不同年份表结构差异
3. **向后兼容**：支持2024年和2025年数据，可扩展其他年份

## 🎯 结论与建议

### 主要结论
1. **门架途中流量理论得到验证**：84.3%的途中流量占比证明门架主要承担通道功能
2. **收费广场一致性理论得到强有力验证**：入口0.993、出口0.990的相关系数证明高度一致性
3. **入口和出口差异合理**：入口92.4%vs出口86.1%的差异有明确的业务解释
4. **数据质量评估体系建立**：为日常监控和异常检测提供科学依据
5. **跨年份分析能力**：支持历史数据对比和趋势分析

### 改进建议
1. **提升OD数据质量**：
   - 优化ETC设备识别算法
   - 改进数据传输稳定性
   - 建立数据质量实时监控

2. **完善分析体系**：
   - 扩展到更长时间窗口分析
   - 增加不同时段的对比分析
   - 建立历史趋势分析

3. **应用推广**：
   - 将分析结果应用于交通管理决策
   - 建立定期分析报告机制
   - 培训相关人员使用分析工具

## 📚 附录

### A. 工具使用指南

#### 脚本运行命令
```bash
# 2025年数据分析
python run_detailed_correlation.py --start-date "2025-07-07 08:00:00" --end-date "2025-07-07 09:00:00"

# 2024年数据分析（自动检测）
python run_detailed_correlation.py --start-date "2024-07-08 08:00:00" --end-date "2024-07-08 09:00:00"

# 指定输出目录
python run_detailed_correlation.py --start-date "2025-07-07 08:00:00" --end-date "2025-07-07 09:00:00" --output-dir custom_output
```

#### 环境变量设置
```bash
# Windows PowerShell（请修改为实际的数据库信息）
$env:DB_HOST="your_db_host"
$env:DB_PORT="your_db_port"
$env:DB_NAME="your_db_name"
$env:DB_USER="your_username"
$env:DB_PASSWORD="your_password"

# Linux/Mac（请修改为实际的数据库信息）
export DB_HOST="your_db_host"
export DB_PORT="your_db_port"
export DB_NAME="your_db_name"
export DB_USER="your_username"
export DB_PASSWORD="your_password"
```

### B. 输出文件说明

#### 生成的文件列表
1. **detailed_correlation_report.html**：完整的分析报告（可在浏览器中查看）
2. **detailed_gantry_origin_correlation.json**：门架起点分析详细数据
3. **gantry_destination_analysis.json**：门架终点分析详细数据
4. **gantry_transit_analysis.json**：门架途中流量分析详细数据
5. **detailed_toll_square_correlation.json**：收费广场入口分析详细数据
6. **detailed_toll_square_exit_correlation.json**：收费广场出口分析详细数据
7. **toll_square_balance_analysis.json**：收费广场流量平衡分析详细数据
8. **toll_square_median_entry_analysis.json**：收费广场入口中位数案例分析
9. **toll_square_median_exit_analysis.json**：收费广场出口中位数案例分析

#### 关键指标解释
- **correlation_coefficient**：相关系数，范围[-1,1]，越接近1表示正相关性越强
- **od_flow_ratio**：OD数量与流量总数的比值
- **transit_ratio**：途中流量占总流量的比例
- **balance_ratio_stats.median**：进出流量比的中位数（替代平均值）

### C. 故障排除

#### 常见问题及解决方案

1. **数据库连接失败**
   ```
   错误：psycopg2.OperationalError: could not connect to server
   解决：检查环境变量设置，确认数据库服务状态
   ```

2. **年份表不存在**
   ```
   错误：relation "dwd.dwd_od_g4202" does not exist
   解决：确认数据库中存在对应年份的数据表
   ```

3. **字段不存在错误**
   ```
   错误：column "gantry_id" does not exist
   解决：检查数据表结构，确认字段映射配置
   ```

4. **关联数据为空**
   ```
   警告：收费广场出口关联数据为空
   解决：检查时间范围设置，确认该时段有数据
   ```

### D. 版本更新日志

#### v2.0 (2025-07-21)
- 🆕 支持2024年和2025年数据自动切换
- 🔧 修复收费广场出口分析数据不一致问题
- 🔧 修复时间过滤逻辑错误
- 🗑️ 移除无意义的平均进出流量比计算
- 📊 优化统计指标计算基准
- 🔒 隐藏敏感数据库信息

#### v1.0 (2025-07-18)
- 🎉 首次发布完整分析功能
- 📊 实现门架和收费广场关联分析
- 📈 建立数据质量评估体系

### E. 性能优化建议

1. **数据库查询优化**：
   - 使用时间分区索引
   - 限制查询字段数量
   - 合理设置时间范围

2. **内存使用优化**：
   - 分批处理大数据集
   - 及时释放不需要的DataFrame
   - 使用数据类型优化

3. **跨年份分析优化**：
   - 缓存年份检测结果
   - 预编译SQL模板
   - 复用数据库连接

---

**报告生成时间**：2025-07-21
**分析工具版本**：detailed_correlation_analysis.py v2.0
**支持数据源**：
- 2025年：dwd.dwd_od_weekly, dwd.dwd_flow_gantry_weekly, dwd.dwd_flow_onramp_weekly, dwd.dwd_flow_offramp_weekly
- 2024年：dwd.dwd_od_g4202, dwd.dwd_flow_gantry, dwd.dwd_flow_onramp, dwd.dwd_flow_offramp
**文档版本**：v2.0
