# 高速公路OD与流量关联分析 - 快速使用指南

## 🚀 快速开始

### 1. 环境准备

```bash
# 设置数据库连接（Windows PowerShell）
# 请修改为实际的数据库连接信息
$env:DB_HOST="your_db_host"
$env:DB_PORT="your_db_port"
$env:DB_NAME="your_db_name"
$env:DB_USER="your_username"
$env:DB_PASSWORD="your_password"

# Linux/Mac
export DB_HOST="your_db_host"
export DB_PORT="your_db_port"
export DB_NAME="your_db_name"
export DB_USER="your_username"
export DB_PASSWORD="your_password"
```

### 2. 跨年份数据分析

#### 2025年数据分析（当前）

```bash
# 进入分析目录
cd 02basedata_process/od_analysis

# 分析2025年1小时数据（推荐）
python run_detailed_correlation.py --start-date "2025-07-07 08:00:00" --end-date "2025-07-07 09:00:00"

# 分析2025年30分钟数据（快速测试）
python run_detailed_correlation.py --start-date "2025-07-07 08:00:00" --end-date "2025-07-07 08:30:00"
```

#### 2024年历史数据分析

```bash
# 系统自动检测年份并切换到对应数据表
# 2024年数据使用：dwd.dwd_od_g4202, dwd.dwd_flow_gantry, dwd.dwd_flow_onramp, dwd.dwd_flow_offramp
python run_detailed_correlation.py --start-date "2024-07-08 08:00:00" --end-date "2024-07-08 09:00:00"

# 分析2024年特定时段
python run_detailed_correlation.py --start-date "2024-12-25 08:00:00" --end-date "2024-12-25 09:00:00"
```

#### 跨年份对比分析

```bash
# 先分析2024年数据
python run_detailed_correlation.py --start-date "2024-07-08 08:00:00" --end-date "2024-07-08 09:00:00" --output-dir output_2024

# 再分析2025年数据
python run_detailed_correlation.py --start-date "2025-07-07 08:00:00" --end-date "2025-07-07 09:00:00" --output-dir output_2025

# 对比两个输出目录的结果
```

### 3. 查看结果

- **HTML报告**：`detailed_correlation_output/detailed_correlation_report.html`
- **详细数据**：`detailed_correlation_output/*.json`

## 📊 关键指标解读（基于最新报告v2.0）

### 门架分析指标

- **途中流量占比**：正常范围75%-90%（当前84.3%）
- **OD占比**：正常范围20%-35%（当前28.9%）
- **功能分类**：
  - 通道型（>80%途中流量）：163个（71.8%）
  - 混合型（20%-80%途中流量）：46个（20.3%）
  - 起止型（<20%途中流量）：18个（7.9%）

### 收费广场分析指标

- **入口相关系数**：正常范围0.99+（当前0.993）
- **出口相关系数**：正常范围0.98+（当前0.990）
- **入口OD/流量比**：正常范围85%-95%（当前中位数92.4%）
- **出口OD/流量比**：正常范围80%-90%（当前中位数86.1%）
- **进出流量平衡比**：当前中位数0.930

### 数据表结构差异

| 项目     | 2024年表                 | 2025年表                        |
| -------- | ------------------------ | ------------------------------- |
| OD数据   | `dwd.dwd_od_g4202`     | `dwd.dwd_od_weekly`           |
| 门架流量 | `dwd.dwd_flow_gantry`  | `dwd.dwd_flow_gantry_weekly`  |
| 入口流量 | `dwd.dwd_flow_onramp`  | `dwd.dwd_flow_onramp_weekly`  |
| 出口流量 | `dwd.dwd_flow_offramp` | `dwd.dwd_flow_offramp_weekly` |
| 门架字段 | `gantry_id`            | `station_code`                |
| 流量计算 | 需要累加各车型           | 直接使用total字段               |

## ⚠️ 异常检测（更新指标）

### 需要关注的异常

1. **入口OD/流量比偏离92%超过15%**

   - 可能原因：ETC设备故障、数据传输问题
   - 处理：检查设备状态和数据完整性
2. **出口OD/流量比偏离86%超过15%**

   - 可能原因：出口检测设备问题、交通模式变化
   - 处理：分析设备状态和交通流量模式
3. **门架途中流量占比低于75%**

   - 可能原因：新增起止点功能、交通模式变化
   - 处理：分析门架功能变化趋势
4. **收费广场相关系数低于0.98**

   - 可能原因：数据质量问题、设备同步问题
   - 处理：检查数据源一致性

## 🔧 常见问题

### Q1: 如何分析2024年数据？

**A**: 系统会自动检测年份并选择对应数据表

```bash
# 直接使用2024年日期，系统自动适配
python run_detailed_correlation.py --start-date "2024-07-08 08:00:00" --end-date "2024-07-08 09:00:00"
```

### Q2: 2024年和2025年数据结果为什么不同？

**A**:

- 表结构不同：2024年需要计算总流量，2025年直接使用预计算字段
- 字段映射：门架表中 `gantry_id`映射为 `station_code`
- 数据处理：两年的数据清洗和聚合逻辑可能有差异

### Q3: 数据库连接失败

**A**: 检查环境变量设置

```bash
# Windows
echo $env:DB_HOST
# Linux/Mac  
echo $DB_HOST
```

### Q4: 脚本运行时间过长

**A**:

- 减少时间范围（建议1小时以内）
- 选择数据量较少的时段
- 确保数据库连接稳定

### Q5: 关联数据为空

**A**:

- 检查时间范围，确认该时段有数据
- 验证年份检测是否正确
- 确认对应年份的数据表是否存在

## 📈 日常监控建议（更新版）

### 每日检查

- [ ] 收费广场入口OD/流量比是否在85%-95%
- [ ] 收费广场出口OD/流量比是否在80%-90%
- [ ] 门架途中流量占比是否在75%-90%
- [ ] 异常收费广场数量（不平衡比例当前97.6%）

### 每周分析

- [ ] 门架功能分类变化趋势（通道型71.8%，混合型20.3%，起止型7.9%）
- [ ] 收费广场相关系数稳定性（目标：入口>0.99，出口>0.98）
- [ ] 跨年份数据对比（如果有历史数据）

### 异常处理优先级

1. **立即处理**：相关系数<0.98，OD/流量比偏离>20%
2. **优先处理**：途中流量占比<75%，流量平衡严重偏离
3. **定期处理**：轻微的数据质量问题，功能分类变化

## 📋 输出文件说明（更新版）

| 文件名                                         | 内容             | 用途               |
| ---------------------------------------------- | ---------------- | ------------------ |
| `detailed_correlation_report.html`           | 完整分析报告     | 查看总体结果和趋势 |
| `detailed_gantry_origin_correlation.json`    | 门架起点分析     | 门架起点功能评估   |
| `gantry_transit_analysis.json`               | 门架途中流量分析 | 门架功能分类评估   |
| `detailed_toll_square_correlation.json`      | 收费广场入口分析 | 入口流量一致性评估 |
| `detailed_toll_square_exit_correlation.json` | 收费广场出口分析 | 出口流量一致性评估 |
| `toll_square_median_entry_analysis.json`     | 入口中位数案例   | 深度案例分析       |
| `toll_square_median_exit_analysis.json`      | 出口中位数案例   | 深度案例分析       |
| `toll_square_balance_analysis.json`          | 流量平衡分析     | 异常收费广场识别   |

## 🎯 核心结论（基于最新分析）

1. **门架通道功能验证**：84.3%途中流量占比，71.8%为通道型门架
2. **收费广场高度一致**：入口0.993、出口0.990相关系数
3. **一致性差异合理**：入口92.4%vs出口86.1%，差异约6个百分点
4. **历史对比能力**：支持2024年和2025年数据对比分析

## 🔄 版本更新

### v2.0 新功能

- ✅ 自动检测年份并切换数据表
- ✅ 支持2024年历史数据分析
- ✅ 修复收费广场出口分析数据不一致问题
- ✅ 优化统计指标计算基准
- ✅ 隐藏敏感数据库信息

### 使用建议

- **新用户**：从2025年数据开始分析
- **历史分析**：使用2024年数据进行趋势对比
- **数据质量监控**：重点关注相关系数和OD/流量比
- **异常检测**：建立基于新指标的监控机制

---

*更多详细信息请参考《高速公路OD与流量关联分析总结报告.md》v2.0*

如遇到问题，请检查：

1. 数据库连接配置是否正确
2. 对应年份数据表是否存在
3. 时间范围是否合理（建议1小时内）
4. 环境变量是否正确设置
