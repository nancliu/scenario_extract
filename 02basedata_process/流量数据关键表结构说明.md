# 流量数据关键表结构说明

---

## 一、静态维度表（dim）

### 1. dim.point_gantry

- **用途**：主线门架点位信息，作为流量统计、路径还原等基础空间参考。
- **主要字段**：| 字段名                   | 类型                 | 说明           |
  | ------------------------ | -------------------- | -------------- |
  | route_code               | varchar(255)         | 路线编码       |
  | section_name             | varchar(255)         | 路段名称       |
  | gantry_id                | varchar(255)         | 门架ID         |
  | gantry_name              | varchar(255)         | 门架名称       |
  | gantry_stake             | double precision     | 桩号           |
  | lng_ori/lat_ori          | numeric(12,8)/(11,8) | 原始经纬度     |
  | lng_84/lat_84            | numeric(12,8)/(11,8) | WGS84经纬度    |
  | lng_02/lat_02            | numeric(12,8)/(11,8) | 02坐标系经纬度 |
  | route_name               | varchar(100)         | 路线名称       |
  | section_code             | varchar(100)         | 路段编码       |
  | gantry_pos               | integer              | 门架位置序号   |
  | gantry_pos_desc          | varchar(255)         | 门架位置描述   |
  | demonstration_id         | integer              | 示范项目ID     |
  | demonstration_route_code | varchar(255)         | 示范路线编码   |
  | demonstration_route_name | varchar(255)         | 示范路线名称   |
- **索引**：gantry_id、gantry_name、route_code、lng_84+lat_84等

---

### 2. dim.point_service_zone

- **用途**：服务区点位信息，服务区流量、事件等分析基础。
- **主要字段**：| 字段名                   | 类型                 | 说明           |
  | ------------------------ | -------------------- | -------------- |
  | route_code               | varchar(255)         | 路线编码       |
  | route_name               | varchar(255)         | 路线名称       |
  | company_name             | varchar(255)         | 管理公司名称   |
  | section_name             | varchar(255)         | 路段名称       |
  | service_area_code        | varchar(255)         | 服务区编码     |
  | service_area_name        | varchar(255)         | 服务区名称     |
  | szm_stake                | double precision     | 桩号           |
  | lng_84/lat_84            | numeric(12,8)/(11,8) | WGS84经纬度    |
  | lng_02/lat_02            | numeric(12,8)/(11,8) | 02坐标系经纬度 |
  | demonstration_id         | integer              | 示范项目ID     |
  | demonstration_route_code | varchar(100)         | 示范路线编码   |
  | demonstration_route_name | varchar(100)         | 示范路线名称   |
- **索引**：service_area_code、service_area_name、route_code、lng_84+lat_84等

---

### 3. dim.point_toll_square

- **用途**：收费广场点位信息，收费站流量、事件等分析基础。
- **主要字段**：| 字段名                   | 类型                 | 说明           |
  | ------------------------ | -------------------- | -------------- |
  | station_code_js          | varchar(50)          | 计费系统站编码 |
  | station_name             | varchar(100)         | 站点名称       |
  | square_code              | varchar(50)          | 广场编码       |
  | square_name              | varchar(100)         | 广场名称       |
  | lng_ori/lat_ori          | numeric(12,8)/(11,8) | 原始经纬度     |
  | lng_84/lat_84            | numeric(12,8)/(11,8) | WGS84经纬度    |
  | route_code               | varchar              | 路线编码       |
  | section_name             | varchar              | 路段名称       |
  | route_name               | varchar(100)         | 路线名称       |
  | section_code             | varchar(100)         | 路段编码       |
  | demonstration_id         | integer              | 示范项目ID     |
  | demonstration_route_code | varchar(100)         | 示范路线编码   |
  | demonstration_route_name | varchar(100)         | 示范路线名称   |
  | direction                | varchar(10)          | 方向           |
  | square_stake             | double precision     | 桩号           |
  | station_code             | varchar(50)          | 站点编码       |
- **索引**：square_code、square_name、station_code、lng_84+lat_84等

---

### 4. dim.point_toll_84

- **用途**：收费站点位信息，含空间点（geometry），用于空间分析、路径还原等。
- **主要字段**：| 字段名                   | 类型                 | 说明            |
  | ------------------------ | -------------------- | --------------- |
  | id                       | integer              | 主键            |
  | geom                     | geometry(Point,4326) | 空间点（WGS84） |
  | route_code               | varchar              | 路线编码        |
  | route_name               | varchar              | 路线名称        |
  | group_name               | varchar              | 分组名称        |
  | unit_name                | varchar              | 单位名称        |
  | company_name             | varchar              | 公司名称        |
  | section_name             | varchar              | 路段名称        |
  | station_name             | varchar              | 站点名称        |
  | tgm_stake                | double precision     | 桩号            |
  | lng/lat                  | double precision     | 经度/纬度       |
  | demonstration_id         | integer              | 示范项目ID      |
  | demonstration_route_code | varchar              | 示范路线编码    |
  | demonstration_route_name | varchar              | 示范路线名称    |
  | station_code_js          | varchar(50)          | 计费系统站编码  |
  | station_code             | varchar(50)          | 站点编码        |
- **主键**：id
- **空间索引**：geom
- **其它索引**：station_code、station_name、route_code等

---

## 二、流量事实表（dwd）

### 1. dwd.dwd_flow_gantry_weekly

- **用途**：门架按周统计的流量数据，原始数据为5分钟统计汇总，包含分车型流量及速度、距离等。
- **主要字段**：| 字段名         | 类型          | 说明                 |
  | -------------- | ------------- | -------------------- |
  | id             | bigint        | 主键，自增           |
  | start_gantryid | varchar(50)   | 起始门架ID           |
  | end_gantryid   | varchar(50)   | 终止门架ID           |
  | gantry_name    | varchar(100)  | 门架名称             |
  | start_time     | timestamp     | 周起始时间（分区键） |
  | k1             | integer       | 客车类型1流量        |
  | k2             | integer       | 客车类型2流量        |
  | k3             | integer       | 客车类型3流量        |
  | k4             | integer       | 客车类型4流量        |
  | h1             | integer       | 货车类型1流量        |
  | h2             | integer       | 货车类型2流量        |
  | h3             | integer       | 货车类型3流量        |
  | h4             | integer       | 货车类型4流量        |
  | h5             | integer       | 货车类型5流量        |
  | h6             | integer       | 货车类型6流量        |
  | t1             | integer       | 特殊车辆类型1流量    |
  | t2             | integer       | 特殊车辆类型2流量    |
  | t3             | integer       | 特殊车辆类型3流量    |
  | t4             | integer       | 特殊车辆类型4流量    |
  | t5             | integer       | 特殊车辆类型5流量    |
  | t6             | integer       | 特殊车辆类型6流量    |
  | total          | integer       | 总流量               |
  | total_k        | integer       | 客车总流量           |
  | total_h        | integer       | 货车总流量           |
  | total_t        | integer       | 特殊车辆总流量       |
  | avg_speed      | numeric(10,2) | 平均速度             |
  | avg_duration   | numeric(10,2) | 平均通行时长         |
  | distance       | numeric(10,3) | 距离                 |
  | batch_id       | varchar(50)   | 批次号               |
  | created_at     | timestamp     | 创建时间             |
  | updated_at     | timestamp     | 更新时间             |
- **分区**：RANGE (start_time)
- **主键**：id, start_time
- **索引**：start_gantryid、start_time、唯一(start_gantryid, start_time)

---

### 2. dwd.dwd_flow_offramp_weekly

- **用途**：下匝道（出口）按周统计的流量数据，原始数据为5分钟统计汇总，包含分车型流量。
- **主要字段**：| 字段名       | 类型         | 说明                 |
  | ------------ | ------------ | -------------------- |
  | id           | bigint       | 主键，自增           |
  | station_code | varchar(50)  | 站点编码             |
  | station_name | varchar(100) | 站点名称             |
  | square_code  | varchar(50)  | 广场编码             |
  | square_name  | varchar(100) | 广场名称             |
  | start_time   | timestamp    | 周起始时间（分区键） |
  | k1           | integer      | 客车类型1流量        |
  | k2           | integer      | 客车类型2流量        |
  | k3           | integer      | 客车类型3流量        |
  | k4           | integer      | 客车类型4流量        |
  | h1           | integer      | 货车类型1流量        |
  | h2           | integer      | 货车类型2流量        |
  | h3           | integer      | 货车类型3流量        |
  | h4           | integer      | 货车类型4流量        |
  | h5           | integer      | 货车类型5流量        |
  | h6           | integer      | 货车类型6流量        |
  | t1           | integer      | 特殊车辆类型1流量    |
  | t2           | integer      | 特殊车辆类型2流量    |
  | t3           | integer      | 特殊车辆类型3流量    |
  | t4           | integer      | 特殊车辆类型4流量    |
  | t5           | integer      | 特殊车辆类型5流量    |
  | t6           | integer      | 特殊车辆类型6流量    |
  | total        | integer      | 总流量               |
  | total_k      | integer      | 客车总流量           |
  | total_h      | integer      | 货车总流量           |
  | total_t      | integer      | 特殊车辆总流量       |
  | batch_id     | varchar(50)  | 批次号               |
  | created_at   | timestamp    | 创建时间             |
  | updated_at   | timestamp    | 更新时间             |
- **分区**：RANGE (start_time)
- **主键**：id, start_time
- **索引**：square_code、start_time、station_code、唯一(square_code, start_time)

---

### 3. dwd.dwd_flow_onramp_weekly

- **用途**：上匝道（入口）按周统计的流量数据，原始数据为5分钟统计汇总，包含分车型流量。
- **主要字段**：| 字段名       | 类型         | 说明                 |
  | ------------ | ------------ | -------------------- |
  | id           | bigint       | 主键，自增           |
  | station_code | varchar(50)  | 站点编码             |
  | station_name | varchar(100) | 站点名称             |
  | square_code  | varchar(50)  | 广场编码             |
  | square_name  | varchar(100) | 广场名称             |
  | start_time   | timestamp    | 周起始时间（分区键） |
  | k1           | integer      | 客车类型1流量        |
  | k2           | integer      | 客车类型2流量        |
  | k3           | integer      | 客车类型3流量        |
  | k4           | integer      | 客车类型4流量        |
  | h1           | integer      | 货车类型1流量        |
  | h2           | integer      | 货车类型2流量        |
  | h3           | integer      | 货车类型3流量        |
  | h4           | integer      | 货车类型4流量        |
  | h5           | integer      | 货车类型5流量        |
  | h6           | integer      | 货车类型6流量        |
  | t1           | integer      | 特殊车辆类型1流量    |
  | t2           | integer      | 特殊车辆类型2流量    |
  | t3           | integer      | 特殊车辆类型3流量    |
  | t4           | integer      | 特殊车辆类型4流量    |
  | t5           | integer      | 特殊车辆类型5流量    |
  | t6           | integer      | 特殊车辆类型6流量    |
  | total        | integer      | 总流量               |
  | total_k      | integer      | 客车总流量           |
  | total_h      | integer      | 货车总流量           |
  | total_t      | integer      | 特殊车辆总流量       |
  | batch_id     | varchar(50)  | 批次号               |
  | created_at   | timestamp    | 创建时间             |
  | updated_at   | timestamp    | 更新时间             |
- **分区**：RANGE (start_time)
- **主键**：id, start_time
- **索引**：square_code、start_time、station_code、唯一(square_code, start_time)

---

### 4. dwd.dwd_od_weekly

- **用途**：OD对（出入口对）按周统计的流量明细，原始数据为每辆车的OD数据，包含车辆类型、起止点、方向等。
- **主要字段**：| 字段名             | 类型         | 说明               |
  | ------------------ | ------------ | ------------------ |
  | id                 | bigint       | 主键，自增         |
  | pass_id            | varchar(50)  | 唯一通行标识       |
  | vehicle_type       | varchar(10)  | 车辆类型           |
  | start_time         | timestamp    | 入口时间（分区键） |
  | start_square_code  | varchar(50)  | 入口广场编码（可为空） |
  | start_square_name  | varchar(100) | 入口广场名称（可为空） |
  | start_station_code | varchar(50)  | 入口站点编码/门架编号 |
  | start_station_name | varchar(100) | 入口站点名称/门架名称 |
  | end_time           | timestamp    | 出口时间           |
  | end_square_code    | varchar(50)  | 出口广场编码（可为空） |
  | end_square_name    | varchar(100) | 出口广场名称（可为空） |
  | end_station_code   | varchar(50)  | 出口站点编码/门架编号 |
  | end_station_name   | varchar(100) | 出口站点名称/门架名称 |
  | direction          | varchar(10)  | 行驶方向           |
  | batch_id           | varchar(50)  | 批次号             |
  | created_at         | timestamp    | 创建时间           |
  | updated_at         | timestamp    | 更新时间           |
- **分区**：RANGE (start_time)
- **主键**：id, start_time
- **索引**：start_time、唯一(pass_id, start_time)

**重要说明：OD点位编码规则**
- **收费广场模式**：当 `square_code` 不为空时，表示收费广场，使用 `square_code` 作为OD点位编码
- **门架模式**：当 `square_code` 为空时，表示门架点位，使用 `station_code`（此时代表门架编号）作为OD点位编码
- **OD对构建规则**：`起点编码-终点编码`，其中编码优先使用 `square_code`，为空时使用 `station_code`
- **混合OD对**：可能存在收费广场到门架、门架到收费广场、门架到门架等多种组合类型

---

## 三、车辆类型分类说明

根据《收费公路车辆通行费车型分类》（JT/T 489-2019）标准，收费公路车辆分为客车、货车和专项作业车三大类。

### 客车类型 (K类)

按照公安机关交通管理部门机动车注册登记的车辆类型和核定载人数分类：

- **k1**: 1类客车
  - 7座及以下小型客车
  - 摩托车
- **k2**: 2类客车
  - 8-19座客车
- **k3**: 3类客车
  - 20-39座客车
- **k4**: 4类客车
  - 40座及以上大型客车

### 货车类型 (H类)

按照车辆总轴数、车长和最大允许总质量进行分类：

- **h1**: 1类货车
  - 2轴货车，车长<6米且最大允许总质量≤4.5吨
- **h2**: 2类货车
  - 2轴货车，车长≥6米或最大允许总质量>4.5吨
- **h3**: 3类货车
  - 3轴货车
- **h4**: 4类货车
  - 4轴货车
- **h5**: 5类货车
  - 5轴货车
- **h6**: 6类货车
  - 6轴货车

### 专项作业车类型 (T类)

按照车辆总轴数进行分类，参照货车分类方式：

- **t1**: 1类专项作业车
  - 2轴专项作业车
- **t2**: 2类专项作业车
  - 3轴专项作业车
- **t3**: 3类专项作业车
  - 4轴专项作业车
- **t4**: 4类专项作业车
  - 5轴专项作业车
- **t5**: 5类专项作业车
  - 6轴专项作业车
- **t6**: 6类专项作业车
  - 6轴以上专项作业车（统一按6轴车辆分类）

### 汇总字段说明

- **total**: 所有车型的总流量 (k1+k2+k3+k4+h1+h2+h3+h4+h5+h6+t1+t2+t3+t4+t5+t6)
- **total_k**: 客车总流量 (k1+k2+k3+k4)
- **total_h**: 货车总流量 (h1+h2+h3+h4+h5+h6)
- **total_t**: 专项作业车总流量 (t1+t2+t3+t4+t5+t6)

### 重要说明

1. **客车分类变化**: 2019年新标准将8-9座客车从2类调整为1类
2. **货车分类依据**: 从按载重吨位改为按轴数分类，解决"大吨小标"问题
3. **专项作业车**: 新增车辆大类，包括工程专项作业车辆
4. **6轴以上货车**: 按超限运输车辆执行，具体分类由各地制定

---

## 四、数据关系说明

### 维度表关系

1. **路线层级关系**：
   - `route_code`(路线代码) - 顶层路线标识
   - `section_code`(路段代码) - route_code的细分，提供更细粒度的路段划分
2. **空间点位关联**：
   - **门架、收费站、服务区**通过 `route_code`(路线代码)关联
   - 如果有 `section_code`，可通过路段进行更细粒度的关联
3. **收费设施关联**：
   - **收费广场**通过 `station_code`与收费站关联
4. **坐标系统**：
   - 包含多种格式，建议优先使用WGS84坐标系(`lng_84`, `lat_84`)

### 事实表关系

1. **门架流量表**通过 `start_gantryid`、`end_gantryid`关联门架维度表
2. **上下匝道流量表**通过 `station_code`/`square_code`关联收费站/广场维度表
3. **OD表**通过起讫点的 `station_code`/`square_code`关联收费站维度表

### 时间维度

- **流量事实表数据粒度差异**：
- - **门架流量、上下匝道流量表**：原始数据为5分钟统计汇总
  - **OD流量表**：原始数据为每辆车的明细数据
- 使用分区表按周范围分区，提高查询性能

---

## 五、使用注意事项

1. **分区表查询**: 所有流量表都是分区表，查询时需要包含时间条件以提高性能
2. **坐标系统**: 包含多种坐标格式，建议优先使用WGS84坐标系
3. **车辆类型**: 流量统计按16种车型分别记录，可根据需要进行汇总计算
4. **批次管理**: `batch_id`用于数据处理的批次管理和追踪
5. **流量事实表数据粒度**:
   - **门架、上下匝道流量表**：数据为5分钟统计汇总
   - **OD表**：原始数据为每辆车的明细数据
6. **OD点位编码处理**:
   - 构建OD对时需要处理 `square_code` 为空的情况
   - 优先使用 `square_code`，为空时使用 `station_code`（门架编号）
   - 需要区分收费广场、门架、混合类型的OD对
7. **数据完整性**: 建议通过汇总字段验证明细数据的一致性

---

> 本文档为后续流量数据算法开发、数据接口设计、数据质量校验等提供结构参考。
