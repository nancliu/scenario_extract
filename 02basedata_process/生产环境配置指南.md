# 生产环境配置指南

## 环境变量配置方法

### 1. Windows 系统

#### 方法1: 使用命令行（临时）
```cmd
set DB_HOST=your_database_host
set DB_PORT=5432
set DB_NAME=your_database_name
set DB_USER=your_username
set DB_PASSWORD=your_password

# 然后在同一个命令行窗口运行
python run_od_analysis.py --quick
```

#### 方法2: 使用批处理脚本
```cmd
# 1. 编辑 set_env.bat 文件，修改数据库参数
# 2. 运行脚本
set_env.bat

# 3. 在同一个命令行窗口运行分析
python run_od_analysis.py --quick
```

#### 方法3: 系统环境变量（永久）
1. 右键"此电脑" → "属性" → "高级系统设置"
2. 点击"环境变量"
3. 在"系统变量"中添加：
   - `DB_HOST` = `your_database_host`
   - `DB_PORT` = `5432`
   - `DB_NAME` = `your_database_name`
   - `DB_USER` = `your_username`
   - `DB_PASSWORD` = `your_password`
4. 重启命令行窗口

#### 方法4: PowerShell
```powershell
$env:DB_HOST="your_database_host"
$env:DB_PORT="5432"
$env:DB_NAME="your_database_name"
$env:DB_USER="your_username"
$env:DB_PASSWORD="your_password"

python run_od_analysis.py --quick
```

### 2. Linux/macOS 系统

#### 方法1: 使用命令行（临时）
```bash
export DB_HOST="your_database_host"
export DB_PORT="5432"
export DB_NAME="your_database_name"
export DB_USER="your_username"
export DB_PASSWORD="your_password"

python run_od_analysis.py --quick
```

#### 方法2: 使用脚本
```bash
# 1. 编辑 set_env.sh 文件，修改数据库参数
# 2. 运行脚本
source set_env.sh

# 3. 运行分析
python run_od_analysis.py --quick
```

#### 方法3: 添加到 shell 配置文件（永久）
```bash
# 编辑 ~/.bashrc 或 ~/.zshrc
echo 'export DB_HOST="your_database_host"' >> ~/.bashrc
echo 'export DB_PORT="5432"' >> ~/.bashrc
echo 'export DB_NAME="your_database_name"' >> ~/.bashrc
echo 'export DB_USER="your_username"' >> ~/.bashrc
echo 'export DB_PASSWORD="your_password"' >> ~/.bashrc

# 重新加载配置
source ~/.bashrc
```

### 3. 使用 .env 文件（推荐）

#### 创建 .env 文件
```bash
# 复制示例文件
cp .env.example .env

# 编辑 .env 文件
nano .env
```

#### .env 文件内容
```
DB_HOST=your_database_host
DB_PORT=5432
DB_NAME=your_database_name
DB_USER=your_username
DB_PASSWORD=your_password
```

#### 运行分析
```bash
python run_od_analysis.py --quick
```

## 生产环境最佳实践

### 1. 安全性
- ✅ 使用环境变量存储敏感信息
- ✅ 不要将密码写入代码或配置文件
- ✅ 使用 .gitignore 忽略 .env 文件
- ✅ 定期更换数据库密码
- ✅ 使用最小权限原则

### 2. 容器化部署 (Docker)

#### Dockerfile 示例
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# 不要在镜像中包含敏感信息
CMD ["python", "run_od_analysis.py"]
```

#### docker-compose.yml 示例
```yaml
version: '3.8'
services:
  od-analysis:
    build: .
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - ./output:/app/od_analysis_output
```

#### 运行容器
```bash
# 设置环境变量
export DB_HOST=your_database_host
export DB_PORT=5432
export DB_NAME=your_database_name
export DB_USER=your_username
export DB_PASSWORD=your_password

# 运行容器
docker-compose up
```

### 3. Kubernetes 部署

#### Secret 配置
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
stringData:
  DB_HOST: "your_database_host"
  DB_PORT: "5432"
  DB_NAME: "your_database_name"
  DB_USER: "your_username"
  DB_PASSWORD: "your_password"
```

#### Deployment 配置
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: od-analysis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: od-analysis
  template:
    metadata:
      labels:
        app: od-analysis
    spec:
      containers:
      - name: od-analysis
        image: od-analysis:latest
        envFrom:
        - secretRef:
            name: db-secret
```

### 4. CI/CD 集成

#### GitHub Actions 示例
```yaml
name: OD Analysis
on:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点运行

jobs:
  analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Run analysis
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: python run_od_analysis.py --quick
```

## 验证配置

### 检查环境变量
```bash
# 检查配置
python run_od_analysis.py --config-check

# 或者直接检查环境变量
echo $DB_HOST    # Linux/macOS
echo %DB_HOST%   # Windows CMD
echo $env:DB_HOST # Windows PowerShell
```

### 测试连接
```python
# 测试脚本
from config import DATABASE_CONFIG, validate_config

if validate_config():
    print("✅ 配置验证通过")
    print(f"将连接到: {DATABASE_CONFIG['host']}:{DATABASE_CONFIG['port']}/{DATABASE_CONFIG['database']}")
else:
    print("❌ 配置验证失败")
```

## 故障排除

### 常见问题
1. **环境变量未设置**: 确保在运行脚本的同一个会话中设置了环境变量
2. **权限问题**: 确保数据库用户有足够的权限
3. **网络问题**: 检查防火墙和网络连接
4. **服务未启动**: 确保PostgreSQL服务正在运行

### 调试命令
```bash
# 检查环境变量
env | grep DB_

# 测试数据库连接
psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME

# 查看日志
tail -f od_analysis.log
```
